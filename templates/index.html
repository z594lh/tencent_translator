<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>腾讯云智能翻译器</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<div class="container">
  <h1>🌐 腾讯云智能翻译器</h1>

  <!-- 统一输入区 -->
  <div id="input-container" class="input-box">
    <textarea id="input-text" placeholder="在此输入文字，或复制图片后 Ctrl+V 粘贴..." onkeydown="handleKeydown(event)"></textarea>
    <img id="preview-image" class="preview-image" />
  </div>

  <!-- 控制区 -->
  <div class="controls">
    <select id="source-lang">
      <option value="auto">自动检测</option>
      <option value="en">英语</option>
      <option value="zh">中文</option>
      <option value="ja">日语</option>
      <option value="ko">韩语</option>
    </select>
    <span>→</span>
    <select id="target-lang">
      <option value="zh">中文</option>
      <option value="en">英语</option>
      <option value="ja">日语</option>
      <option value="ko">韩语</option>
    </select>
    <button onclick="doTranslate('machine')">机器翻译</button>
    <button onclick="doTranslate('ai')">AI翻译</button>
    <button onclick="clearInput()" style="background: #ccc;">清除</button>
  </div>

  <!-- 结果展示 -->
  <div class="result-box" id="result-box">
    翻译结果将显示在这里...
  </div>
</div>

<footer style="text-align: center; padding: 20px; background-color: #f8f8f8; border-top: 1px solid #e7e7e7;">
  <p>Powered by <a href="{{ author_link }}" target="_blank">zhongyw</a></p>
</footer>

<script>
let currentContent = ""; // 存储粘贴的图片 base64 数据

// 处理键盘事件（主要是 Enter 提交）
function handleKeydown(event) {
  const textarea = event.target;
  if (event.key === 'Enter' && !event.shiftKey) {
    event.preventDefault();
    doTranslate(); // 按下 Enter 直接翻译
  }
}

// 清除输入内容
function clearInput() {
  document.getElementById("input-text").value = "";        // 清空文本框
  document.getElementById("preview-image").src = "";       // 清空图片预览
  document.getElementById("preview-image").style.display = "none"; // 隐藏图片
  currentContent = "";                                     // 清空缓存图片数据

  // 恢复文本区域显示
  document.getElementById("input-container").classList.remove("has-image");
}

// 粘贴事件监听（支持 Ctrl+V 和右键粘贴图片）
document.addEventListener('paste', function(e) {
  const items = (e.clipboardData || window.clipboardData).items;
  for (let item of items) {
    if (item.type.indexOf('image') !== -1) {
      const blob = item.getAsFile();
      const reader = new FileReader();
      reader.onload = function(event) {
        const image_b64 = event.target.result.split(',')[1]; // 去掉前缀
        document.getElementById("preview-image").src = event.target.result;
        document.getElementById("preview-image").style.display = "block";
        currentContent = image_b64;

        // 隐藏文本区域，显示图片
        document.getElementById("input-container").classList.add("has-image");
      };
      reader.readAsDataURL(blob);
    }
  }
});


// 判断是否中文主导
function isChineseDominant(text, threshold = 0.5) {
  const chineseChars = text.match(/[\u4e00-\u9fa5]/g) || [];
  const totalChars = text.replace(/\s+/g, '').length;
  if (totalChars === 0) return false;
  return chineseChars.length / totalChars >= threshold;
}

// 判断是否英文主导（粗略判断非中文字符比例）
function isEnglishDominant(text, threshold = 0.7) {
  const englishChars = text.replace(/[\u4e00-\u9fa5\s]+/g, '').length;
  const totalChars = text.replace(/\s+/g, '').length;
  if (totalChars === 0) return false;
  return englishChars / totalChars >= threshold;
}


// 执行翻译
function doTranslate(type) {
  const inputText = document.getElementById("input-text").value.trim();
  const loadingOverlay = document.getElementById("loading-overlay");

  if (!inputText && !currentContent) {
    alert("请输入文字或粘贴图片");
    return;
  }


  // 显示加载动画
  loadingOverlay.style.display = "flex";

  const sourceSelect = document.getElementById("source-lang");
  const targetSelect = document.getElementById("target-lang");


  const source = sourceSelect.value;
  let target = targetSelect.value;

  let isImage = false;
  let payload = {};

  if (currentContent) {
    isImage = true;
    payload.image = currentContent;
  } else {
    payload.text = inputText;

    // 自动根据文本内容调整目标语言
    if (source === 'auto') {
        if (isChineseDominant(inputText)) {
            // 中文主导，且目标语言是中文，则默认翻译成英文
            if (target === 'zh') {
                target = 'en';
            }
        } else if (isEnglishDominant(inputText)) {
            // 英文主导，且目标语言是英文，则默认翻译成中文
            if (target === 'en') {
                target = 'zh';
            }
        }
    }

    targetSelect.value = target;

  }


  // 根据 type 和 isImage 构建 URL
  let url = '';
  if (type === 'ai') {
    // AI 翻译
    url = isImage ? "/translate-ai-image" : "/translate-ai";
  } else {
    // 默认是机器翻译，不管 type 是 undefined 还是其他无效值
    url = isImage ? "/translate-image" : "/translate";
  }


  fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ ...payload, source, target })
  })
  .then(res => res.json())
  .then(data => {
    resultHtml = data.translated;
    document.getElementById("result-box").innerHTML = resultHtml;
  })
  .catch(err => {
    console.error(err);
    alert("翻译失败，请查看控制台错误信息");
  })
  .finally(() => {
    // 不管成功还是失败，都隐藏 loading
    loadingOverlay.style.display = "none";
  });

}
</script>

</body>
<!-- 加载遮罩 -->
<div id="loading-overlay" class="loading-overlay">
  <div class="loading-spinner"></div>
</div>
</html>