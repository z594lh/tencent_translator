<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>腾讯云翻译器</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>

<div class="container">
  <h1>🌐 腾讯云在线翻译器</h1>

  <div class="translator-box">
    <textarea id="input-text" onkeydown="handleKeydown(event)" placeholder="在此输入要翻译的内容..."></textarea>
    
    <div class="controls">
      <select id="source-lang">
        <option value="auto">自动检测</option>
        <option value="en">英语</option>
        <option value="zh">中文</option>
        <option value="ja">日语</option>
        <option value="ko">韩语</option>
        <!-- 可以继续添加更多语言选项 -->
      </select>
      
      <span>→</span>
      
      <select id="target-lang">
        <option value="zh">中文</option>
        <option value="en">英语</option>
        <option value="ja">日语</option>
        <option value="ko">韩语</option>
        <option value="ms">马来语</option>
        <!-- 可扩展 -->
      </select>
      
      <button onclick="doTranslate()">翻译</button>
    </div>

    <div class="result-box" id="result-box">
      翻译结果将显示在这里...
    </div>
  </div>
</div>

<footer style="text-align: center; padding: 20px; background-color: #f8f8f8; border-top: 1px solid #e7e7e7;">
    <p>Powered by <a href="{{ author_link }}" target="_blank">zhongyw</a></p>
</footer>
<script>


function handleKeydown(event) {
  const textarea = event.target;

  // Shift + Enter → 插入换行
  if (event.key === 'Enter' && event.shiftKey) {
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    textarea.setRangeText('\n', start, end, 'end');
    event.preventDefault();
  }

  // 单独 Enter → 触发翻译
  else if (event.key === 'Enter' && !event.shiftKey) {
    event.preventDefault();
    doTranslate();
  }
}


// 判断是否中文主导
function isChineseDominant(text, threshold = 0.5) {
  const chineseChars = text.match(/[\u4e00-\u9fa5]/g) || [];
  const totalChars = text.replace(/\s+/g, '').length;
  if (totalChars === 0) return false;
  return chineseChars.length / totalChars >= threshold;
}

// 判断是否英文主导（粗略判断非中文字符比例）
function isEnglishDominant(text, threshold = 0.7) {
  const englishChars = text.replace(/[\u4e00-\u9fa5\s]+/g, '').length;
  const totalChars = text.replace(/\s+/g, '').length;
  if (totalChars === 0) return false;
  return englishChars / totalChars >= threshold;
}

function doTranslate() {
  const input = document.getElementById("input-text").value.trim();


  const sourceSelect = document.getElementById("source-lang");
  const targetSelect = document.getElementById("target-lang");

  if (!input) {
    alert("请输入要翻译的内容");
    return;
  }

  const source = sourceSelect.value;
  let target = targetSelect.value;

  // 自动根据文本内容调整目标语言
  if (source === 'auto') {
    if (isChineseDominant(input)) {
      // 中文主导，且目标语言是中文，则默认翻译成英文
      if (target === 'zh') {
        target = 'en';
      }
    } else if (isEnglishDominant(input)) {
      // 英文主导，且目标语言是英文，则默认翻译成中文
      if (target === 'en') {
        target = 'zh';
      }
    }
  }

  fetch("/translate", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ text: input, source, target })
  })
  .then(res => res.json())
  .then(data => {
    document.getElementById("result-box").innerText = data.translated;
  })
  .catch(err => {
    console.error(err);
    alert("翻译失败，请查看控制台错误信息");
  });
}
</script>

</body>
</html>